version: 1
applications:
  - backend:
      phases:
        preBuild:
          commands:
            - echo "Installing Infisical CLI..."
            - timeout 300 sudo curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.rpm.sh' | sudo -E bash || { echo "Failed to download Infisical repo setup"; exit 1; }
            - timeout 300 sudo yum -y install infisical || { echo "Failed to install Infisical"; exit 1; }
            - which infisical || { echo "Infisical not found in PATH"; exit 1; }
            - echo "Infisical CLI installed successfully"
        build:
          commands:
            - echo "Authenticating with Infisical..."
            - export INFISICAL_TOKEN=$(timeout 60 infisical login --method=universal-auth --client-id=${INFISICAL_CLIENT_ID} --client-secret=${INFISICAL_CLIENT_SECRET} --silent --plain --domain https://eu.infisical.com) || { echo "Failed to authenticate with Infisical"; exit 1; }
            - echo "Authentication successful, token acquired"
            - echo "Exporting environment variables..."
            - timeout 60 infisical export --format=dotenv --token=${INFISICAL_TOKEN} > .env || { echo "Failed to export environment variables"; exit 1; }
            - source .env || { echo "Failed to source .env file"; exit 1; }
            - echo "Installing dependencies..."
            - npm ci --cache .npm --prefer-offline || { echo "Failed to install npm dependencies"; exit 1; }
            - echo "Deploying backend..."
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID || { echo "Failed to deploy backend"; exit 1; }
    frontend:
      phases:
        preBuild:
          commands:
            - echo "Installing Infisical CLI..."
            - timeout 300 sudo curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.rpm.sh' | sudo -E bash || { echo "Failed to download Infisical repo setup"; exit 1; }
            - timeout 300 sudo yum -y install infisical || { echo "Failed to install Infisical"; exit 1; }
            - which infisical || { echo "Infisical not found in PATH"; exit 1; }
            - echo "Infisical CLI installed successfully"
        build:
          commands:
            - echo "Authenticating with Infisical..."
            - export INFISICAL_TOKEN=$(timeout 60 infisical login --method=universal-auth --client-id=${INFISICAL_CLIENT_ID} --client-secret=${INFISICAL_CLIENT_SECRET} --silent --plain --domain https://eu.infisical.com) || { echo "Failed to authenticate with Infisical"; exit 1; }
            - echo "Authentication successful, token acquired"
            - echo "Exporting environment variables..."
            - timeout 60 infisical export --format=dotenv --token=${INFISICAL_TOKEN} > .env || { echo "Failed to export environment variables"; exit 1; }
            - echo "Building frontend..."
            - npm run build || { echo "Failed to build frontend"; exit 1; }
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - .next/cache/**/*
          - .npm/**/*
    appRoot: frontend
